import React, { useState } from "react";
import { useDrag, useDrop, DndProvider } from "react-dnd";
import { HTML5Backend } from "react-dnd-html5-backend";
import { Button } from "@/components/ui/button";

const goals = [
  "Clarity", "Simplicity", "Speed", "Accuracy", "Transparency",
  "Efficiency", "Support", "Consistency", "Flexibility", "Autonomy",
  "Communication", "Accessibility", "Fairness", "Trust", "Timeliness",
  "Predictability", "Professionalism", "Collaboration", "Usability", "Respect",
  "Responsiveness", "Guidance", "Accountability", "Understanding", "Security",
  "Empowerment", "Streamlining", "Reliability", "Compliance", "Innovation"
];

const pileNames = {
  important: "Important",
  neutral: "Neutral",
  notImportant: "Not Important",
  unassigned: "Unassigned"
};

const Card = ({ card }) => {
  const [{ isDragging }, drag] = useDrag(() => ({
    type: "CARD",
    item: { card },
    collect: (monitor) => ({
      isDragging: monitor.isDragging()
    })
  }), [card]);

  return (
    <div
      ref={drag}
      className="bg-white shadow p-2 m-1 rounded cursor-move text-center hover:bg-blue-100"
      style={{ opacity: isDragging ? 0.5 : 1 }}
    >
      {card}
    </div>
  );
};

const Pile = ({ label, pileKey, cards, onDropCard }) => {
  const [, drop] = useDrop(() => ({
    accept: "CARD",
    drop: (item) => onDropCard(item.card, pileKey)
  }), [cards]);

  return (
    <div ref={drop} className="border rounded p-4 m-2 w-full sm:w-1/4 min-h-[300px]">
      <h2 className="font-bold text-lg mb-2 text-center">{label}</h2>
      {cards.map((card) => (
        <Card key={card} card={card} />
      ))}
    </div>
  );
};

export default function CardSortGame() {
  const [piles, setPiles] = useState({
    important: [],
    neutral: [],
    notImportant: [],
    unassigned: goals
  });

  const [topFive, setTopFive] = useState([]);

  const moveCard = (card, targetPile) => {
    setPiles((prev) => {
      const newPiles = {
        important: [],
        neutral: [],
        notImportant: [],
        unassigned: []
      };
      for (const pile in prev) {
        newPiles[pile] = prev[pile].filter((c) => c !== card);
      }
      newPiles[targetPile] = [...prev[targetPile].filter((c) => c !== card), card];
      return newPiles;
    });
  };

  const handleTopFiveSelect = (card) => {
    if (topFive.includes(card)) return;
    if (topFive.length < 5) setTopFive([...topFive, card]);
  };

  const handleTopFiveReset = () => setTopFive([]);

  return (
    <DndProvider backend={HTML5Backend}>
      <div className="p-6">
        <h1 className="text-2xl font-bold mb-4">Card Sorting Game</h1>
        <p className="mb-4">Drag cards between piles. Then select your top 5 goals from the "Important" pile.</p>

        <div className="flex flex-wrap justify-between">
          {Object.entries(pileNames).map(([key, name]) => (
            <Pile
              key={key}
              label={name}
              pileKey={key}
              cards={piles[key]}
              onDropCard={moveCard}
            />
          ))}
        </div>

        <div className="mt-8">
          <h2 className="text-xl font-semibold mb-2">Select Top 5 from "Important"</h2>
          <div className="flex flex-wrap">
            {piles.important.map((card) => (
              <Button
                key={card}
                className={`m-1 ${topFive.includes(card) ? "bg-blue-500 text-white" : ""}`}
                onClick={() => handleTopFiveSelect(card)}
                disabled={topFive.length >= 5 && !topFive.includes(card)}
              >
                {card}
              </Button>
            ))}
          </div>
          <div className="mt-4">
            <h3 className="font-semibold">Your Top 5 Goals:</h3>
            <ol className="list-decimal ml-6">
              {topFive.map((card, idx) => <li key={idx}>{card}</li>)}
            </ol>
            <Button className="mt-2" onClick={handleTopFiveReset}>Reset Top 5</Button>
          </div>
        </div>
      </div>
    </DndProvider>
  );
}
